# template.zip -- hex 
####################################################################################################
TEMPLATE_B64 = """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\
8ucmVsc1BLBQYAAAAABQAFADoBAAAMCwAAAAA="""
####################################################################################################

import base64
from zipfile import ZipFile

####################################################################################################
                                        # Experiment #
####################################################################################################

SAMPLE_DATA = {
    'sales':{
        'table': [
            ["Product", "Units\nSold", "Revenue ($)"],
            ["Laptop", 120, 96000],
            ["Smartphone\nMobile", 250, 125000],
            ["Tablet", 180, 54000],
            ["Headphones", 300, 45000]
        ],
        'header': True,
        'columnWidths': [20, 10, 10]
    },
    'plants': {
        'table': [
            ["Plant Name", "Type", "Water Needs", "Sunlight"],
            ["Rose & thorns", "Flowers", "Medium", "Full> Sun"],
            ["Cactu\'s", "Succulent", "Low", "Full Sun"],
            ["Fern", "Fol\"iage", "High", "Partial Shade"],
            ["Aloe <Vera", "Succulent", "Low", "Bright\nIndirect"],
            ["Tulip", "Flower", "Medium", "Full Sun"]
        ]
    }
}

import re 
from datetime import datetime
dt_str = datetime.now().isoformat()[:19]+'Z'

def getTemplateElements(template_zip, filename):
    template_content = template_zip.read(filename)
    return re.findall(r'<[^<>]+>', template_content)

template_xml = {
    '[Content_Types].xml':[
        # '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>',
        '<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">',
        '<Default ContentType="application/vnd.openxmlformats-package.relationships+xml" Extension="rels" />',
        '<Default ContentType="application/xml" Extension="xml" />',
        '<Override ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml" PartName="/xl/styles.xml" />',
        '<Override ContentType="application/vnd.openxmlformats-officedocument.theme+xml" PartName="/xl/theme/theme1.xml" />',
        '<Override ContentType="application/vnd.openxmlformats-package.core-properties+xml" PartName="/docProps/core.xml" />',
        '<Override ContentType="application/vnd.openxmlformats-officedocument.extended-properties+xml" PartName="/docProps/app.xml" />',
        '<Override ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml" PartName="/xl/workbook.xml" />',
        '<Override ContentType="application/vnd.ms-office.classificationlabels+xml" PartName="/docMetadata/LabelInfo.xml"/>',
        '</Types>'],
    'docProps/core.xml':[
        '<cp:coreProperties xmlns:cp="http://schemas.openxmlformats.org/package/2006/metadata/core-properties" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:dcterms="http://purl.org/dc/terms/" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance">',
        '<dc:creator>',
        '</dc:creator>',
        '<dcterms:created xsi:type="dcterms:W3CDTF">',
        '</dcterms:created>',
        '<dcterms:modified xsi:type="dcterms:W3CDTF">',
        '</dcterms:modified>',
        '</cp:coreProperties>'
    ],
    'xl/_rels/workbook.xml.rels':['<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">', '</Relationships>'],
    'xl/workbook.xml':[
        '<workbook xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">',
        '<workbookPr />',
        '<workbookProtection />',
        '<bookViews>',
        '<workbookView activeTab="0" autoFilterDateGrouping="1" firstSheet="0" minimized="0" showHorizontalScroll="1" showSheetTabs="1" showVerticalScroll="1" tabRatio="600" visibility="visible" />',
        '</bookViews>',
        '<sheets>',
        '</sheets>',
        '<definedNames />',
        '<calcPr calcId="124519" fullCalcOnLoad="1" />',
        '</workbook>'
    ],
    'sheet.xml': [
        '<worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main">',
        '<dimension ref="A1" />',
        '<sheetViews>',
        '<sheetView workbookViewId="0">',
        '</sheetView>',
        '</sheetViews>',
        '<sheetFormatPr baseColWidth="8" defaultRowHeight="15" />',
        '</worksheet>'
    ]
}

COLUMN_FRMT_XML = '<col min="{0}" max="{0}" width="{1}"/>'
HEADER_CELL_XML = '<c {}t="inlineStr" xml:space="preserve"><is><t>{}</t></is></c>'
STRING_CELL_XML = '<c {}t="inlineStr" xml:space="preserve"><is><t>{}</t></is></c>'
NUMBER_CELL_XML = '<c t="n"><v>{}</v></c>'

def buildColumnFormattingXML(colwidths):
    xml = ['<cols>']
    for col_idx, col_width in enumerate(colwidths):
        xml.append(
            COLUMN_FRMT_XML.format(col_idx+1, col_width)
        )
    xml.append('</cols>')
    return xml

def escapeXMLChars(text):
    escapeXML = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&apos;"
    }

    result = ''
    for c in text:
        if c in escapeXML:
            result += escapeXML[c]
        else:
            result += c 
    return result

def buildSheetXML(table, header=False):
    if table:
        xml = ['<sheetData>']
        for row_idx, row in enumerate(table):
            xml.append('<row r="{}">'.format(row_idx+1))
            for e in row:
                style = ''
                e_str = escapeXMLChars(str(e))
                # style
                if (row_idx == 0) and header:
                    if '\n' in e_str:
                        style = 's="3" '
                    else:
                        style = 's="1" '
                    xml.append(HEADER_CELL_XML.format(style, e_str))
                else:
                    if '\n' in e_str:
                        style = 's="2" '
                    else:
                        style = ''
                    if isinstance(e, str):
                        xml.append(STRING_CELL_XML.format(style, e_str))
                    elif isinstance(e, (int, float)):
                        xml.append(NUMBER_CELL_XML.format(e_str))
                    else:
                        xml.append(STRING_CELL_XML.format(style, e_str))
            xml.append('</row>')
        xml.append('</sheetData>')
        return xml
    else:
        return ['<sheetData />']
    

def createWorkbook(data, filepath):
    # load
    with open(filepath, 'wb') as f:
        f.write(base64.b64decode(TEMPLATE_B64))
        f.close()

    with ZipFile(filepath, 'a') as zip:
        # content types ###########################################################################
        template_elements = template_xml['[Content_Types].xml']
        # edit
        editString = '<Override ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml" '\
                    + 'PartName="/xl/worksheets/sheet{}.xml" />'
        new_elements = [editString.format(idx+1) for idx, sheet in enumerate(data)]
        zip_elements = template_elements[:8] + new_elements + template_elements[8:]
        # write
        zip.writestr('[Content_Types].xml', ''.join(zip_elements))
        
        # core.xml  ###############################################################################
        template_elements = template_xml['docProps/core.xml']
        # edit
        zip_elements =  template_elements[0:2] + ['openpyxl'] +\
                        template_elements[2:4] + [dt_str] +\
                        template_elements[4:6] + [dt_str] + template_elements[6:]
        # write
        zip.writestr('docProps/core.xml', ''.join(zip_elements))
            
        # workbook.xml.rels  ######################################################################
        template_elements =  template_xml['xl/_rels/workbook.xml.rels'] # remove formatting
        # edit
        editString = '<Relationship  Id="rId{0}" Target="/xl/worksheets/sheet{0}.xml" '\
                        + 'Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" />'
        new_elements = [editString.format(idx+1) for idx, sheet in enumerate(data)]
        new_elements += [
            ('<Relationship  Id="rId{}" Target="styles.xml" '\
                + 'Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" />').format(len(data)+1),
            ('<Relationship  Id="rId{}" Target="theme/theme1.xml" ' \
                + 'Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/theme"  />').format(len(data)+2)
        ]
        zip_elements =  template_elements[:1] + new_elements + template_elements[1:]
        
        # write
        zip.writestr('xl/_rels/workbook.xml.rels', ''.join(zip_elements))

        # workbook.xml  ###########################################################################
        template_elements =  template_xml['xl/workbook.xml'] # remove formatting
        # edit
        editString = '<sheet name="{1}" sheetId="{0}" state="visible" r:id="rId{0}" />'
        new_elements = [editString.format(idx+1, sheet_name) for idx, sheet_name in enumerate(data)]
        zip_elements =  template_elements[:7] + new_elements + template_elements[7:]
        zip.writestr('xl/workbook.xml', ''.join(zip_elements))
        
        # sheet.xml  ##############################################################################
        for sheet_idx, (sheet_name, meta_data) in enumerate(data.items()):
            template_elements =  template_xml['sheet.xml']
            new_elements = []

            # parse sheet meta args
            if 'columnWidths' in meta_data:
                new_elements += buildColumnFormattingXML(meta_data['columnWidths'])
                pass
            if 'header' in meta_data:
                header = meta_data['header']
            else:
                header = False
            if 'table' in meta_data:
                table = meta_data['table']
            else:
                table = []
            
            new_elements += buildSheetXML(table, header)
            zip_elements = template_elements[:-1] + new_elements + template_elements[-1:]
            
            zip.writestr('xl/worksheets/sheet{}.xml'.format(sheet_idx+1), ''.join(zip_elements))
            # break
            
        zip.close()
    
    return None

# createWorkbook(SAMPLE_DATA, 'sample_test.xlsx')        
        
